version: 2.1
orbs:
  ruby: circleci/ruby@0.1.2 

jobs:
  build:
    docker:
      - image: cimg/ruby:3.0.0-browsers
    steps:
      - checkout
      - run:
          name: Which bundler?
          command: bundle -v
      - run:
          name: Update Bundle
          command: bundle update
      - ruby/bundle-install
      # Run rubocop  
      - run:  
          name: Run rubocop  
          command:  bundle exec rubocop app/models app/controllers
           
deploy:
  machine: true
  steps:
    - checkout
    - run: |-
        cat >> ~/.netrc \<<EOF
          machine api.heroku.com
            login $HEROKU_USERNAME
            password $HEROKU_PASSWORD
          machine git.heroku.com
            login $HEROKU_USERNAME
            password $HEROKU_PASSWORD
        EOF
    - run: chmod 600 ~/.netrc 
    - run: heroku git:remote -a pure-wildwood-68673
    - run: git push heroku master:master -f
    - run: heroku run rails db:migrate --app pure-wildwood-68673

workflows:
  version: 2.1
  build_deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: master
